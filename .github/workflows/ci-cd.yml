name: CI-CD Pipeline

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ackrome

jobs:
  cancel:
    name: 'Cancel Other Workflow'
    runs-on: ubuntu-latest
    steps:
      - uses: styfle/cancel-workflow-action@0.9.0
        with:
          access_token: ${{ github.token }}
  # 1. Check what files changed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      base: ${{ steps.filter.outputs.base }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            base:
              - 'requirements.txt'
              - 'Dockerfile.base-python'
              - 'Dockerfile.base-worker'

  # 2. Auto-Versioning (Independent)
  auto-version-patch:
    name: Auto-Version Patch
    if: "!contains(github.event.head_commit.message, 'chore(release)')"
    outputs:
      new_version: ${{ steps.bumper.outputs.new_version }}
      commit_sha: ${{ steps.checkout.outputs.commit_sha }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        id: checkout
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Configure Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run Version Bumper
        id: bumper
        run: |
          python version_bumper.py patch
          git add setup.py requirements.txt
          git commit -m "chore(release): auto-version patch [skip ci]"
          git push origin HEAD:main

  # 3. Publish Shared Lib (Independent)
  publish-shared-lib:
    name: Publish Shared Lib to PyPI
    needs: [auto-version-patch]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip build twine
      - run: python -m build
      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*

  # 4. Build Base Images (Conditional)
  build-base-images:
    name: Build Base Images
    needs: [check-changes]
    if: needs.check-changes.outputs.base == 'true'
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build Python Base
      - name: Build and Push Base Python
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.base-python
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-base-python:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Worker Base (Heavy)
      - name: Build and Push Base Worker
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.base-worker
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-base-worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 5. Build Service Images (Dependent on Logic)
  build-services:
    name: Build Service Images
    needs: [check-changes, build-base-images]
    # Run if base images were built successfully OR if they were skipped (because not needed)
    if: |
      always() && 
      (needs.build-base-images.result == 'success' || needs.build-base-images.result == 'skipped') &&
      (needs.check-changes.result == 'success')
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3

      - name: Maintenance Cleanup
        run: docker system prune -f

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # WORKER (Uses Base Worker)
      - name: Build Worker
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.worker
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-worker:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-worker:latest

      # BOT (Uses Base Python)
      - name: Build Bot
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.bot
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-bot:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-bot:latest

      # API (Uses Base Python)
      - name: Build API
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./fastapi_stats_app/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-api:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-api:latest

      # SCHEDULER (Uses Base Python)
      - name: Build Scheduler
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./scheduler_app/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-scheduler:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/matplobbot-scheduler:latest

      - name: Soft Cleanup
        if: always()
        run: docker system prune -f

  # 6. Deploy
  trigger-deployment:
    name: Trigger Jenkins Deployment
    needs: [build-services]
    runs-on: self-hosted
    steps:
      - name: Trigger Jenkins Job via cURL
        run: |
          curl -X POST "${{ secrets.JENKINS_URL }}/job/matplobbot-deploy/buildWithParameters" \
            --user "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}" \
            --data-urlencode "BOT_IMAGE_TAG=${{ github.sha }}" \
            --data-urlencode "WORKER_IMAGE_TAG=${{ github.sha }}" \
            --data-urlencode "API_IMAGE_TAG=${{ github.sha }}" \
            --data-urlencode "SCHEDULER_IMAGE_TAG=${{ github.sha }}"
