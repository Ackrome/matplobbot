pipeline {
    agent any

    parameters {
        string(name: 'BOT_IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag for the bot')
        string(name: 'API_IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag for the API')
        string(name: 'SCHEDULER_IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag for the scheduler')
    }

    environment {
        PROD_BOT_TOKEN      = credentials('PROD_BOT_TOKEN')
        PROD_ADMIN_USER_IDS = credentials('PROD_ADMIN_USER_IDS')
        PROD_GITHUB_TOKEN   = credentials('PROD_GITHUB_TOKEN')
        PROD_POSTGRES_USER  = credentials('PROD_POSTGRES_USER')
        PROD_POSTGRES_PASSWORD = credentials('PROD_POSTGRES_PASSWORD')
        PROD_POSTGRES_DB    = credentials('PROD_POSTGRES_DB')
        PROD_DATABASE_URL   = "postgresql://${PROD_POSTGRES_USER}:${PROD_POSTGRES_PASSWORD}@postgres:5432/${PROD_POSTGRES_DB}"
    }

    stages {
        stage('Deploy to Production') {
            steps {
                script {
                    // Используем безопасный метод внедрения ключа без ssh-agent
                    withCredentials([sshUserPrivateKey(credentialsId: 'app-vm-ssh-key', keyFileVariable: 'SSH_KEY_FILE', usernameVariable: 'SSH_USER')]) {
                        
                        // Исправляем права на файл ключа (на всякий случай)
                        sh 'chmod 600 $SSH_KEY_FILE'

                        // 1. Обновляем репозиторий
                        sh "ssh -i $SSH_KEY_FILE -o StrictHostKeyChecking=no root@app-vm.panthera-banjo.ts.net 'cd ~/matplobbot && git pull'"
                        
                        // 2. Создаем .env файл
                        sh """
                        ssh -i $SSH_KEY_FILE -o StrictHostKeyChecking=no root@app-vm.panthera-banjo.ts.net "cat > ~/matplobbot/.env" <<EOF
# Generated by Jenkins
BOT_TOKEN=${PROD_BOT_TOKEN}
ADMIN_USER_IDS=${PROD_ADMIN_USER_IDS}
GITHUB_TOKEN=${PROD_GITHUB_TOKEN}
POSTGRES_USER=${PROD_POSTGRES_USER}
POSTGRES_PASSWORD=${PROD_POSTGRES_PASSWORD}
POSTGRES_DB=${PROD_POSTGRES_DB}
DATABASE_URL=${PROD_DATABASE_URL}
EOF
                        """
                        
                        // 3. Очищаем кэш докера
                        sh "ssh -i $SSH_KEY_FILE -o StrictHostKeyChecking=no root@app-vm.panthera-banjo.ts.net 'docker system prune --all --force'"
                        
                        // 4. Запускаем деплой
                        sh "ssh -i $SSH_KEY_FILE -o StrictHostKeyChecking=no root@app-vm.panthera-banjo.ts.net 'cd ~/matplobbot && ./deploy.sh ${params.BOT_IMAGE_TAG} ${params.API_IMAGE_TAG} ${params.SCHEDULER_IMAGE_TAG}'"
                    }
                }
            }
        }
    }
    post {
        always {
            echo 'Deployment finished.'
        }
    }
}